@model RedChess.WebEngine.Repositories.IGameBinding

@{
    ViewBag.Title = "Game";
}

<script src="/Scripts/jquery.cookie.js"></script>
<script src="/Scripts/jquery.signalR-2.1.0.min.js" type="text/javascript"></script>
<script src="/signalr/hubs"></script>
<script src="/Scripts/app/spinner.js" type="text/javascript"></script>
<script src="/Scripts/app/chess.js" type="text/javascript"></script>
<script src="/Scripts/app/chessboard-0.3.0.js"></script>
<link rel="stylesheet" type="text/css" href="/Scripts/app/chessboard-0.3.0.css" />

<style type="text/css">
    .highlight-white {
        -webkit-box-shadow: inset 0 0 3px 3px yellow;
        -moz-box-shadow: inset 0 0 3px 3px yellow;
        box-shadow: inset 0 0 3px 3px yellow;
    }

    .highlight-black {
        -webkit-box-shadow: inset 0 0 3px 3px blue;
        -moz-box-shadow: inset 0 0 3px 3px blue;
        box-shadow: inset 0 0 3px 3px blue;
    }
</style>

@{
    var shouldLock = @Model.ShouldLockUi;
    var clockModel = @Model.Clock;
}

<script type="text/javascript">
    gameId = @Model.GameId;
    currentPlayerColor = '@Model.CurrentPlayerColor(@User.Identity.Name)';
    var theChess;

    $(document).ready(function() {
        var myClock = null;

        @if (clockModel != null)
        {
            <text>
                myClock = new Clock(gameId, @clockModel.TimeLimitMs);
            </text>
        }

        theChess = new Chess(gameId, currentPlayerColor, myClock);

        @if (clockModel != null)
        {
            <text>
            myClock.theChess = theChess;
            myClock.ClockDocumentReady();
            </text>
        }
        theChess.updateUi('@Model.Fen');

        // Draw any user messages, and update the set of taken pieces
        @if (!String.IsNullOrEmpty(@Model.Status))
        {
            <text>
                $("#messages").text('@Model.Status');
                $("#messages").parent().css('visibility', 'visible');
            </text>
        }
        else
        {
            <text>
                $("#messages").html('&nbsp;');
                $("#messages").parent().css('visibility', 'hidden');
            </text>
        }

        $("#lastmove").text('@Model.LastMove');
        theChess.updateTakenPieces('@Model.Fen');

        @if (Model.MayClaimDraw) {
            <text>$('#drawbutton').show()</text>
        }

        @if (Model.GameOver)
        {
            <text>theChess.endGame();</text>
        }
        

        @if (shouldLock)
        {
            <text>theChess.lockBoard();</text>
        }
    });
</script>  

 @if (!Request.IsAuthenticated)
 {
     <text><div>You must be <a href="/">logged in</a> to participate in games.</div></text>
 }

<div class="row">
    <div class="col-md-7">
        <h2 id="title">@Model.Description</h2>
        <div style="width: 512px; margin-bottom: 10px" id="board"></div>
        
        <div class="btn-group" role="group">
                <a class="btn btn-default" id="resignbutton" onclick="theChess.resignGame(); ">Resign</a>
                <a class="btn btn-default" id="drawbutton" onclick="theChess.claimDraw(); ">Claim draw</a>
        </div>
    </div>

    <div class="col-md-3">
        <div class="alert alert-danger" role="alert">
            <div id="messages" style="text-align: center">&nbsp;</div>
        </div>
        <div id="submitmove">
            @using (Html.BeginForm("PlayMove", "Board", FormMethod.Post, new { @class = "form-inline"}))
            {
                var items = new List<SelectListItem>
                {
                    new SelectListItem {Value = "Queen", Text = "Queen"},
                    new SelectListItem {Value = "Rook", Text = "Rook"},
                    new SelectListItem {Value = "Knight", Text = "Knight"},
                    new SelectListItem {Value = "Bishop", Text = "Bishop"},
                };

                @Html.AntiForgeryToken()
                @Html.Hidden("Id", Model.GameId)
                @Html.Hidden("Start")
                @Html.Hidden("End")

                <div class="form-group" style="margin-bottom : 10px">
                    <div class="input-group">
                        @Html.DropDownList("Promote", items, new { @class = "form-control"})
                    </div>
                        <input type="submit" value="Submit" id="submitbutton" class="btn btn-primary"/>
                </div>
            }

            @if (clockModel != null)
            {
                @Html.Partial("_Clock", clockModel)
            }

            <div class="well">
                <div id="lastmove"></div>
                <div id="turnindicator"></div>
            </div>
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="blacktaken" style="font-size: 36pt;"></div>
                    <div id="whitetaken" style="font-size: 36pt;"></div>
                </div>
            </div>
        </div>
    </div>
</div>


