@using RedChess.WebEngine.Models
@model IEnumerable<HistoryEntry>

    <script src="/Scripts/app/spinner.js" type="text/javascript"></script>
    <script src="/Scripts/app/boardviewer.js" type="text/javascript"></script>
    <link rel="stylesheet" type="text/css" href="/Scripts/app/viewer.css" />
    <script src="/Scripts/app/chessboard-0.3.0.js"></script>
    <link rel="stylesheet" type="text/css" href="/Scripts/app/chessboard-0.3.0.css" />

    @{
        ViewBag.Title = "History";
        var maxMoves = @Model.Count();

        var currentHistoryEntry = maxMoves == 1 ? @Model.First() : @Model.First(historyEntry => historyEntry.MoveNumber == Math.Max(1, Math.Min(maxMoves, ViewBag.MoveNumber)));
        var description = currentHistoryEntry.Description();
        var isParticipant = currentHistoryEntry.IsParticipant(HttpContext.Current.User.Identity.Name, currentHistoryEntry.GameId);
    }

    <script>
        $(document).ready(function () {
            lastMove = @maxMoves;
            var cfg = { pieceTheme: '/Images/{piece}.png', position: '', showNotation: false };
            board = new ChessBoard('board', cfg);
            renderMoves();
            board.position(positions[0].fen);

            if (location.hash.length != 0) {
                updateBoard(parseInt(location.hash.substring(1)));
            } else {
                updateBoard(0);
            }

            $('#title').text('@description');
            PopulateMovesBox();
            ConfigureActionButtons();
        });
    </script>

    <script>
        function playFromHere() {
            window.location = "/History/PlayFromHere?move=" + currentMove + "&gameId=" + @currentHistoryEntry.GameId;
        }

    </script>

    <script>
        var positions = new Array(@maxMoves);
        var i = 0;

        function renderMoves() {
            @foreach (var data in @Model.Select(x => new {Fen = x.Fen.Split(new[] {' '})[0], Move = x.Move}))
            {
                <text>positions[i++] = { "Fen" : '@data.Fen', "Move" : '@data.Move'} ;</text>
            }
        }
    </script>
    
<div class="container">
    <div class="row">
        <div class="col-lg-3">
            <div class="panel panel-default">
                <div class="panel-heading">@description</div>
                <div id="scrollbox" class="panel-body">
                    <table id="moves"></table>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div id="board"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-3">
            
        </div>
        <div class="col-lg-7">
            <div class="wrapper"><span class="button" id="goStart"></span></div>
            <div class="wrapper"><span class="button" id="goBack"></span></div>
            <div class="wrapper"><span class="button" id="goFlip"></span></div>
            <div class="wrapper"><span class="button" id="goEnd"></span></div>
            <div class="wrapper"><span class="button" id="goForward"></span></div>
        </div>

    </div>
    <div class="row">
        @if (Request.IsAuthenticated && isParticipant)
        {
            <a class="btn btn-default" href="javascript:playFromHere();">Play from here</a>
        }
    </div>

</div>

<div id="main">
        <p id="errors"></p>
            <p class="title">&nbsp;</p>



